<!DOCTYPE html>
<html lang="pt_BR">
  <head>
    <title>Roda Ágil</title>

    <meta charset="UTF-8" />
    <meta
      name="description"
      content="Microsistema Roda Ágil para auxiliar a medir a agilidade de uma equipe de desenvolvimento."
    />
    <meta property="og:title" content="Roda Ágil" />
    <meta
      property="og:description"
      content="Microsistema Roda Ágil para auxiliar a medir a agilidade de uma equipe de desenvolvimento."
    />
    <meta
      property="og:image"
      content="https://rodaagil.agile.thalamus.digital/imgs/os_image.png"
    />
    <meta property="og:type" content="website" />

    <!-- CSS -->
    <link rel="stylesheet" href="./css/bootstrap.min.css" />
    <style>
      .accordion-header button {
        padding: calc(var(--bs-accordion-btn-padding-y) - 8px) 
          calc(var(--bs-accordion-btn-padding-x) - 5px) 
          calc(var(--bs-accordion-btn-padding-y) - 9px) 
          calc(var(--bs-accordion-btn-padding-x) - 5px);
      }
      .accordion-body {
        padding: calc(var(--bs-accordion-body-padding-y) - 10px)
          calc(var(--bs-accordion-body-padding-x) - 10px)
          calc(var(--bs-accordion-body-padding-y) - 10px)
          calc(var(--bs-accordion-body-padding-x) + 5px);
      }

      #footer {
        margin-top: 10px;
        padding-top: 40px;
        padding-bottom: 30px;
        background-color: #ddd;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="container-fluid">
        <header
          class="d-flex flex-wrap justify-content-center py-1 mb-3 border-bottom"
        >
          <a
            href="/"
            class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none"
          >
            <svg class="bi me-2" width="40" height="32">
              <use xlink:href="#bootstrap" />
            </svg>
            <span class="fs-4">Roda Ágil</span>
          </a>

          <ul class="nav">
            <li class="nav-item">
              <a href="#" class="nav-link" id="importar">Importar </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="exportar">Exportar</a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="salvar">Gerar Imagem</a>
            </li>
          </ul>
        </header>
      </div>
    </main>

    <div class="container-fluid">
      <div class="row">
        <div class="col-md-3" id="sidebar">
          <!-- Menu lateral esquedo -->
          <div class="accordion accordion-flush" id="graph-editor">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" 
                  type="button" 
                  data-bs-toggle="collapse" 
                  data-bs-target="#panelsStayOpen-collapseOne" 
                  aria-expanded="false" 
                  aria-controls="panelsStayOpen-collapseOne">
                  Configurações
                </button>
              </h2>
              <div
                id="panelsStayOpen-collapseOne"
                class="accordion-collapse collapsed collapse"
              >
                <div class="accordion-body">
                  <div class="mb-3">
                    <label for="exampleFormControlInput1" class="form-label"
                      >Título/Time:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="time"
                      name="time"
                      placeholder="Informe um título para o card, nome da time, equipe,...."
                    />
                  </div>

                  <div class="mb-3">
                    <label for="exampleFormControlInput1" class="form-label"
                      >Data:</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="date"
                      name="date"
                      placeholder="Informe um título para o card, nome da time, equipe,...."
                    />
                  </div>
                  

                  <div class="input-group input-group-sm">
                    <span class="input-group-text"
                      >
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="showTitle"
                        name="showTitle"
                        checked
                      /></span
                    >
                    <input
                      type="text"
                      class="form-control"
                      value="Exibir título"
                      readonly
                    />
                  </div>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text"
                      >
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="showDate"
                        name="showDate"
                        checked
                      /></span
                    >
                    <input
                      type="text"
                      class="form-control"
                      value="Exibir data"
                      readonly
                    />
                  </div>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text"
                      >
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="showSubtitles"
                        name="showSubtitles"
                      /></span
                    >
                    <input
                      type="text"
                      class="form-control"
                      value="Exibir subtítulos"
                      readonly
                    />
                  </div>
                  <br />

                  <div class="mb-3">
                    <label for="basic-url" class="form-label">Cores:</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"
                        >Textos e Linhas</span
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="texto"
                        value="#002c5b"
                      />
                    </div>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"
                        >Pontuação maior</span
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="cor_maior"
                        value="#00b7ad"
                      />
                    </div>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"
                        >Pontuação média</span
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="cor_media"
                        value="#ffd63f"
                      />
                    </div>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"
                        >Pontuação menor</span
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="cor_menor"
                        value="#ff7474"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-9 text-center">
          <!-- Canvas com a roda ágil -->
          <canvas id="canvas-show" width="800"></canvas>
          <canvas id="canvas-out" width="1400" hidden="true"></canvas>
        </div>
      </div>
    </div>

    <div id="footer" class="container-fluid">
      <div class="row">
        <div class="col"></div>
        <div class="col">
          Microsistema Roda Ágil <br />
          desenvolvido para auxiliar a medir a agilidade de uma equipe.
        </div>
        <div class="col"></div>
        <div class="col">
          Está ferramenta foi construída com base na
          <strong>Roda Ágil</strong> da autora
          <a href="https://www.anagsoares.com/" target="_blank">
            Ana G Soares.
          </a>
        </div>
        <div class="col"></div>
        <div class="col">
          Desenvolvido por
          <a
            href="https://thalamus.digital/"
            target="_blank"
            >Thalamus</a
          >
          <br />

          Link do
          <a
            href="https://github.com/Piemontez/rodaagil"
            target="_blank""
            >Código Fonte</a
          >
        </div>
        <div class="col"></div>
      </div>
    </div>

    <input type="file" id="thefile" style="display: none" />

    <!-- Javascripts -->
    <!-- Bootstrap -->
    <script type="text/javascript" src="./js/bootstrap.min.js"></script>

    <!-- XLS -->
    <script type="text/javascript" src="./js/shim.min.js"></script>
    <script type="text/javascript" src="./js/xlsx.full.min.js"></script>
    <!-- Local -->
    <script type="text/javascript" src="./js/xlssupport.js"></script>
    <script type="text/javascript" src="./js/rodaagilchart.js"></script>

    <script>
      var formEditor = document.querySelector("#graph-editor");
      var currentDate = new Date();
      var chartProps = {
        time: "",
        date: "",
        drawborder: false,
        showTitle: true,
        showDate: true,
        showSubtitles: false,
        colors: {
          text: "#002c5b",
          min: "#ff7474",
          med: "#ffd63f",
          max: "#00b7ad",
        },
        groups: [
          {
            title: "Valor",
            subtitle: "a Todo instante",
            itens: [
              { title: "Colaboração e comunicação", value: 1 },
              { title: "Motivação e confiança", value: 1 },
              { title: "Autonomia e auto-organização", value: 1 },
              { title: "Kaizen", value: 1 },
              { title: "Interdisciplinaridade", value: 1 },
            ],
          },
          {
            title: "Pessoas",
            subtitle: "sensacionais",
            itens: [
              { title: "Práticas Lean-Agile", value: 1 },
              { title: "Métricas e ferramentas", value: 1 },
              { title: "Comprometimento com o produto", value: 1 },
              { title: "Compartilhamento de conhecimento", value: 1 },
              { title: "Ritmo das entregas", value: 1 },
            ],
          },
          {
            title: "Experimente",
            subtitle: "e aprenda rápido",
            itens: [
              { title: "Código sustentável", value: 1 },
              { title: "Automações (Pipeline)", value: 1 },
              { title: "BDD/TDD e Clean Code", value: 1 },
              { title: "Qualidade E2E", value: 1 },
              { title: "DevOps", value: 1 },
            ],
          },
          {
            title: "Segurança",
            subtitle: "um pré requisito",
            itens: [
              { title: "Quebra de Stories, Features e Epics", value: 1 },
              { title: "UX", value: 1 },
              { title: "Entrega de valor", value: 1 },
              { title: "Relacionamento com negócio", value: 1 },
              { title: "Satisfação do cliente", value: 1 },
            ],
          },
        ],
        itens: [],
      };

      // Ajusta tamanho do canvas
      var newWidth = window.innerWidth - document.getElementById("sidebar").offsetWidth - 60;
      if (window.innerHeight - 130 < newWidth) {
        newWidth = window.innerHeight - 130;
      }
      document.getElementById("canvas-show").width = newWidth;
      formEditor.querySelector("input[name=date]").value =
        currentDate.getFullYear() +
        "-" +
        (currentDate.getMonth() < 9
          ? "0" + (currentDate.getMonth() + 1)
          : currentDate.getMonth()) +
        "-" +
        (currentDate.getDate() < 10
          ? "0" + currentDate.getDate()
          : currentDate.getDate());

      function makeForm(chartProps) {
        document
          .querySelectorAll(".group-accordion")
          .forEach((item) => item.remove());

        let groupId = 0;
        let itemId = 0;
        for (const group of chartProps.groups) {
          const accordDiv = document.createElement("div");
          const headerH2 = document.createElement("h2");
          const titleButton = document.createElement("button");
          const collapseDiv = document.createElement("div");
          const bodyDiv = document.createElement("div");
          const addButtonRow = document.createElement("div");
          const addButton = document.createElement("button");

          // Accordion
          accordDiv.className = "accordion-item group-accordion";
          // Accordion header
          headerH2.className = "accordion-header";
          headerH2.append(titleButton);

          // Accordion title
          titleButton.innerHTML = group.title;
          titleButton.className = "accordion-button";
          titleButton.setAttribute("type", "button");
          titleButton.setAttribute("data-bs-toggle", "collapse");
          titleButton.setAttribute("data-bs-target", "#groupsAccord");
          titleButton.setAttribute("aria-expanded", "true");
          titleButton.setAttribute("aria-controls", "groupsAccord");

          // Body
          collapseDiv.id = "groupsAccord";
          collapseDiv.className = "accordion-collapse collapsed collapse show";
          collapseDiv.append(bodyDiv);
          bodyDiv.className = "accordion-body";

          for (const itemPos in group.itens) {
            const item = group.itens[itemPos];
            const itemDiv = document.createElement("div");
            const inputGroupSpan = document.createElement("input");
            const itemInput = document.createElement("input");

            // Item
            itemDiv.className = "input-group input-group-sm row";

            // Span
            inputGroupSpan.className = "input-group-text col-sm-10";
            inputGroupSpan.name = "t" + itemId;
            inputGroupSpan.setAttribute("type", "text");
            inputGroupSpan.setAttribute("value", item.title);

            itemInput.className = "form-control col-sm-2";
            itemInput.name = "" + itemId;
            itemInput.setAttribute("type", "number");
            itemInput.setAttribute("min", "0");
            itemInput.setAttribute("max", "5");
            itemInput.setAttribute("group-pos", "" + groupId);
            itemInput.setAttribute("item-pos", "" + itemPos);
            itemInput.setAttribute("value", item.value);
            itemInput.addEventListener("click", setItemValue);

            itemDiv.append(inputGroupSpan);
            itemDiv.append(itemInput);

            bodyDiv.append(itemDiv);
            itemId++;
          }
          
          // Add button
          addButtonRow.className = "row";

          addButton.innerHTML = "+";
          addButton.className = "btn btn-sm offset-sm-10 col-sm-1";
          addButton.setAttribute("type", "button");
          addButton.setAttribute("group-pos", "" + groupId);
          addButton.addEventListener("click", addGroupItem);

          bodyDiv.append(addButtonRow);
          addButtonRow.append(addButton);

          accordDiv.append(headerH2);
          accordDiv.append(collapseDiv);

          formEditor.append(accordDiv);
          groupId++;
        }
      }

      function loadFormValues() {
        chartProps.drawborder = false;
        chartProps.time =
          formEditor.querySelector("input[name=time]")?.value || "";
        chartProps.date =
          formEditor.querySelector("input[name=date]")?.value || "";

        chartProps.showTitle =
          formEditor.querySelector("input[name=showTitle]")?.checked;
        chartProps.showDate =
          formEditor.querySelector("input[name=showDate]")?.checked;
        chartProps.showSubtitles =
          formEditor.querySelector("input[name=showSubtitles]")?.checked;
          
        chartProps.colors.text =
          formEditor.querySelector("input[id=texto]")?.value || "";
        chartProps.colors.min =
          formEditor.querySelector("input[id=cor_menor]")?.value || "";
        chartProps.colors.med =
          formEditor.querySelector("input[id=cor_media]")?.value || "";
        chartProps.colors.max =
          formEditor.querySelector("input[id=cor_maior]")?.value || "";

        for (var i = 0; i < 100; i++) {
          var inputTitle = formEditor.querySelector('input[name="t' + i + '"]');
          var input = formEditor.querySelector('input[name="' + i + '"]');

          if (inputTitle && input) {
            if (!chartProps.itens[i]) {
              chartProps.itens[i] = {};
            }
            chartProps.itens[i].title = inputTitle ? inputTitle.value : "";
            chartProps.itens[i].value = input ? input.value : ""; 
          }
        }
      }

      function setItemValue() {
        if (this.value === '0') {          
          if (confirm("Deseja remover este item da lista?")) {
            var groupPos = parseInt(this.getAttribute("group-pos"));
            var itemPos = parseInt(this.getAttribute("item-pos"));
            chartProps.groups[groupPos].itens.splice(itemPos,1);

            chartProps.itens = [];

            makeForm(chartProps);
            loadFormValues();
            draw(canvasShow, chartProps);
          } else {
            this.value = '1';
          }
        }
      }

      function addGroupItem() {
        var groupPos = parseInt(this.getAttribute("group-pos"));
        chartProps.groups[groupPos].itens.push({
          title: "",
          value: 1
        })
        chartProps.itens = [];

        makeForm(chartProps);
        loadFormValues();
        draw(canvasShow, chartProps);
      }

      formEditor.addEventListener("change", function () {
        loadFormValues();
        draw(canvasShow, chartProps);
      });

      // Botão salvar imagem
      document.getElementById("salvar").addEventListener("click", function (e) {
        loadFormValues();
        chartProps.drawborder = true;

        draw(canvasOut, chartProps);
        
        this.href = imgData;
        this.download = "Roda-Agil.png";
        
        return false;
      });

      document.getElementById("thefile").addEventListener("change", (event) => {
        const fileList = event.target.files;
        const file = fileList[0];
        const reader = new FileReader();

        reader.onloadend = (e) => {
          let json = null;
          try {
            if (!(file.name || "").toLowerCase().includes("xls")) {
              toast.warn("Envie um arquivo XLS válido");
              this.loaded();
              return;
            }

            json = importarXLS(e.target.result);
          } catch (rs) {
            alert("Formato de arquivo inválido");
            return;
          }
          chartProps = {
            time: "",
            date: "",
            colors: {
              text: "#002c5b",
              min: "#ff7474",
              med: "#ffd63f",
              max: "#00b7ad",
            },
            groups: [],
          };

          for (const line of json) {
            switch (line.field) {
              case "time":
                chartProps.time = line.data;
                break;
              case "date":
                chartProps.date = line.data;
                break;
              case "showTitle":
                chartProps.showTitle = (line.data || '').toLowerCase() === 'true';
                break;
              case "showDate":
                chartProps.showDate = (line.data || '').toLowerCase() === 'true';
                break;
              case "showSubtitles":
                chartProps.showSubtitles = (line.data || '').toLowerCase() === 'true';
                break;
              case "color.text":
                chartProps.colors.text = line.data;
                break;
              case "color.min":
                chartProps.colors.min = line.data;
                break;
              case "color.med":
                chartProps.colors.med = line.data;
                break;
              case "color.max":
                chartProps.colors.max = line.data;
                break;
              case "group":
                chartProps.groups.push({
                  title: line.data,
                  subtitle: line.data2,
                  itens: [],
                });
                break;
              case "item":
                chartProps.groups[chartProps.groups.length - 1].itens.push({
                  title: ("" + line.data).toString(),
                  value: line.data2,
                });
                break;
            }
          }

          draw(canvasShow, chartProps);
        };
        reader.readAsBinaryString(file);
      });

      // Exportar
      document
        .getElementById("importar")
        .addEventListener("click", function (e) {
          var elem = document.getElementById("thefile");
          if (elem && document.createEvent) {
            var evt = document.createEvent("MouseEvents");
            evt.initEvent("click", true, false);
            elem.dispatchEvent(evt);
          }
          return false;
        });

      // Importar
      document
        .getElementById("exportar")
        .addEventListener("click", function (e) {
          var contents = [
            { field: "time", data: chartProps.time, data2: null },
            { field: "date", data: chartProps.date, data2: null },
            { field: "showTitle", data: chartProps.showTitle ? 'true' : 'false', data2: null },
            { field: "showDate", data: chartProps.showDate ? 'true' : 'false', data2: null },
            { field: "showSubtitles", data: chartProps.showSubtitles ? 'true' : 'false', data2: null },
            { field: "color.text", data: chartProps.colors.text },
            { field: "color.min", data: chartProps.colors.min },
            { field: "color.med", data: chartProps.colors.med },
            { field: "color.max", data: chartProps.colors.max },
          ];

          for (var group of chartProps.groups) {
            contents.push({
              field: "group",
              data: group.title,
              data2: group.subtitle,
            });

            for (var item of group.itens) {
              contents.push({
                field: "item",
                data: item.title,
                data2: item.value,
              });
            }
          }

          exportXLS({ contents, filename: "roda_agil" });
          return false;
        });

      makeForm(chartProps);
      loadFormValues();
      draw(canvasShow, chartProps);
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7KE1TBX2NB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7KE1TBX2NB');
    </script>
  </body>
</html>
